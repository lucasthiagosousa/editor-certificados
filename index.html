<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Editor Visual de Certificados</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f0f2f5; --panel: #ffffff; --muted: #6b7280; --accent: #007bff;
      --border: #dee2e6; --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --text-color: #1f2937; --guide-color: #ff4d4f;
      --default-bg: #e9ecef; /* Cor do fundo cinza padrão */
    }
    html, body { height: 100%; margin: 0; overflow: hidden; }
    body {
      font-family: 'Poppins', system-ui, sans-serif;
      background-color: var(--bg); color: var(--text-color); font-size: 14px;
      display: flex;
    }
    
    #sidebar {
        width: 380px; flex-shrink: 0; background-color: var(--panel);
        border-right: 1px solid var(--border); padding: 20px;
        overflow-y: auto; height: 100vh;
    }
    #main-content {
        flex-grow: 1; padding: 24px; overflow: auto; height: 100vh;
    }
    .control-group {
        border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 20px;
    }
    .control-group:last-child { border-bottom: none; }
    
    h1 { font-family: "Montserrat", serif; font-size: 24px; margin: 0 0 4px 0; }
    .sub { color: var(--muted); font-size: 14px; margin-bottom: 24px;}
    h2 { font-size: 16px; font-weight: 600; margin: 0 0 16px 0; }
    
    label { display: block; font-size: 13px; font-weight: 500; margin: 12px 0 6px; color: #4b5563; }
    input, select, button {
      width: 100%; background: #f9fafb; border: 1px solid var(--border); color: var(--text-color);
      border-radius: 8px; padding: 10px 14px; font-size: 14px; outline: none; transition: all 0.2s ease;
    }
    input[type="checkbox"] { width: auto; }
    input[type="color"] { padding: 5px; height: 40px; }
    .checkbox-group { display: flex; align-items: center; gap: 8px; margin-top: 10px; }

    input:focus, select:focus { border-color: var(--accent); background-color: #fff; box-shadow: 0 0 0 2px rgba(0,123,255,.2); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }
    .btn { cursor: pointer; font-weight: 600; border: 0; padding: 11px 16px; border-radius: 8px; background: var(--accent); color: #ffffff; }
    .btn:hover:not(:disabled) { background: #0069d9; }
    .btn:disabled { background-color: #a0a0a0; cursor: not-allowed;}
    .btn-ghost { cursor: pointer; padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--panel); color: var(--text-color); font-weight: 500;}
    .btn-ghost:hover:not(:disabled) { background-color: #f8f9fa; border-color: #adb5bd; }
    .muted { color: var(--muted); font-size: 13px; margin: 8px 0 0; }

    /* === Editor e Guias de Alinhamento === */
    .stage {
        position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        background-color: var(--default-bg); /* FUNDO CINZA PADRÃO */
        background-size: 100% 100%; background-repeat: no-repeat;
        margin: 0 auto;
    }
    .fields-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .guide { position: absolute; background-color: var(--guide-color); z-index: 10; }
    .guide-h { width: 100%; height: 1px; left: 0; }
    .guide-v { height: 100%; width: 1px; top: 0; }

    .field {
      position: absolute; display: flex; align-items: center; justify-content: center;
      border: 1px dashed rgba(0, 123, 255, 0.7); border-radius: 8px;
      background: rgba(0, 123, 255, 0.08); cursor: move;
    }
    .field.active { outline: 2px solid var(--accent); background: rgba(0, 123, 255, 0.15); }
    .field .label { position: absolute; top: -20px; left: 0; font-size: 12px; background: var(--accent); color: #fff; padding: 3px 8px; border-radius: 999px; }
    .field .text { width: 100%; text-align: center; pointer-events: none; }
    .field img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
    
    .badge { font-size: 13px; background: #e7f3ff; color: #0056b3; border: 1px solid #b3d7ff; padding: 6px 12px; border-radius: 999px; text-align: center; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>

  <!-- PAINEL DE CONTROLE FIXO À ESQUERDA -->
  <aside id="sidebar">
      <h1>Editor de Certificados</h1>
      <p class="sub">Edite tudo diretamente na imagem.</p>
      <div class="control-group">
          <h2>1. Fundo e Objetos</h2>
          <label>Imagem de Fundo (PNG/JPG)</label> <input id="bgInput" type="file" accept="image/png, image/jpeg">
          <div class="actions">
              <button id="btnAddText" class="btn-ghost">+ Adicionar Texto</button>
              <button id="btnAddLogo" class="btn-ghost">+ Adicionar Logo</button>
              <button id="btnClearBg" class="btn-ghost">Limpar Fundo</button>
              <input id="logoInput" type="file" accept="image/png, image/jpeg" style="display:none;" />
          </div>
          <div class="row" style="margin-top: 10px;">
              <div> <label>Largura (px)</label> <input id="w" type="number" placeholder="1280" /> </div>
              <div> <label>Altura (px)</label> <input id="h" type="number" placeholder="720" /> </div>
          </div>
      </div>
      <div id="props-container" class="control-group">
          <div id="noSel">
              <h2>Propriedades</h2>
              <p class="muted">Clique em um elemento no editor para ver suas propriedades aqui.</p>
          </div>
          <div id="props" style="display:none">
              <h2>Propriedades do Elemento</h2>
              <label>ID</label> <input id="pKey" readonly>
              <div id="text-props">
                <label>Texto de exemplo</label> <input id="pSample" />
                <label>Tamanho (px)</label><input id="pFont" type="number" />
                <label>Cor</label><input id="pColor" type="color" value="#000000" />
                <label>Fonte</label>
                <select id="pFamily">
                  <option value="Montserrat">Montserrat</option> <option value="Poppins">Poppins</option>
                  <option value="serif">Serif</option> <option value="sans-serif">Sans-Serif</option> <option value="monospace">Monospace</option>
                </select>
                <label>Alinhamento do Texto</label>
                <select id="pAlign">
                  <option value="center">Centro</option> <option value="left">Esquerda</option> <option value="right">Direita</option>
                </select>
              </div>
              <div id="image-props" class="checkbox-group">
                  <input type="checkbox" id="pLockRatio">
                  <label for="pLockRatio">Manter Proporção</label>
              </div>
              <div class="row">
                <div><label>X (px)</label><input id="pX" type="number" /></div>
                <div><label>Y (px)</label><input id="pY" type="number" /></div>
              </div>
              <div class="row">
                <div><label>Largura (px)</label><input id="pW" type="number" /></div>
                <div><label>Altura (px)</label><input id="pH" type="number" /></div>
              </div>
              <label>Alinhamento Rápido</label>
              <div class="row">
                  <button id="btnCenterH" class="btn-ghost">Centralizar H</button>
                  <button id="btnCenterV" class="btn-ghost">Centralizar V</button>
              </div>
              <div class="actions">
                <button id="btnDuplicar" class="btn-ghost">Duplicar</button>
                <button id="btnRemover" class="btn-ghost">Remover</button>
              </div>
          </div>
      </div>
      <div class="control-group">
          <h2>2. Geração em Lote</h2>
          <label>Planilha (Excel/CSV)</label>
          <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
          <div class="row">
            <div> <label>Coluna NOME (p/ nome do arquivo)</label> <select id="colNome"></select> </div>
            <div> <label>Coluna CPF (Opcional)</label> <select id="colCPF"></select> </div>
          </div>
      </div>
      <div class="control-group">
          <h2>3. Exportar</h2>
          <div class="actions">
            <button id="btnDownloadPreview" class="btn-ghost">Baixar PNG (Prévia)</button>
            <button id="btnGerar" class="btn" disabled>Gerar ZIP (Lote)</button>
          </div>
          <div class="badge" id="status" style="margin-top: 16px;">Pronto para iniciar</div>
      </div>
      <div class="control-group">
          <h2>Layout</h2>
           <div class="actions">
              <button id="btnSalvarLayout" class="btn-ghost">Salvar Layout</button>
              <button id="btnCarregarLayout" class="btn-ghost">Carregar</button>
              <input id="loadLayout" type="file" accept="application/json" style="display:none" />
          </div>
      </div>
  </aside>

  <!-- ÁREA DE EDIÇÃO PRINCIPAL À DIREITA -->
  <main id="main-content">
      <div id="stage" class="stage">
        <div id="fields-container" class="fields-container"></div>
      </div>
  </main>

<script>
  const state = {
    bg: null, stageSize: { w: 1280, h: 720 }, fields: {}, order: [],
    data: [], headers: [], map: { nome: null, cpf: null }, selected: null
  };

  const $ = (selector) => document.querySelector(selector);
  const stage = $('#stage'), fieldsContainer = $('#fields-container'),
        wEl = $('#w'), hEl = $('#h'), statusEl = $('#status'),
        fileInput = $('#fileInput'), colNome = $('#colNome'), colCPF = $('#colCPF'),
        btnGerar = $('#btnGerar'), btnDownloadPreview = $('#btnDownloadPreview'), btnAddLogo = $('#btnAddLogo'), logoInput = $('#logoInput'),
        noSel = $('#noSel'), props = $('#props'), textProps = $('#text-props'), imageProps = $('#image-props'),
        pKey = $('#pKey'), pSample = $('#pSample'), pX = $('#pX'), pY = $('#pY'), pW = $('#pW'), pH = $('#pH'), pFont = $('#pFont'), pColor = $('#pColor'), pFamily = $('#pFamily'), pAlign = $('#pAlign'), pLockRatio = $('#pLockRatio');

  const defaultFields = {
    curso: { type: 'text', x: 140, y: 150, w: 1000, h: 120, font:'Montserrat', size: 42, color:'#111827', align:'center', sample:'“Titulo do Curso”' },
    nome: { type: 'text', x: 140, y: 280, w: 1000, h: 80, font:'Montserrat', size: 64, color:'#000000', align:'center', sample:'Nome do Participante' },
    cpf: { type: 'text', x: 140, y: 370, w: 1000, h: 40, font:'Poppins', size: 22, color:'#4b5563', align:'center', sample:'CPF: 123.456.789-00' },
    empresa: { type: 'text', x: 140, y: 420, w: 1000, h: 110, font:'Montserrat', size: 90, color:'#1f2937', align:'center', sample:'empresa' },
    data: { type: 'text', x: 140, y: 580, w: 300, h: 30, font:'Poppins', size: 18, color:'#4b5563', align:'left', sample:'15 de Agosto de 2025' },
    carga: { type: 'text', x: 840, y: 580, w: 300, h: 30, font:'Poppins', size: 18, color:'#4b5563', align:'right', sample:'Carga Horária: 8 horas' },
  };
  
  function setStatus(msg) {
    statusEl.textContent = msg;
  }

  function initStageSize(w, h) {
    state.stageSize = { w: Number(w) || 1280, h: Number(h) || 720 };
    stage.style.width = state.stageSize.w + 'px';
    stage.style.height = state.stageSize.h + 'px';
    wEl.value = state.stageSize.w; hEl.value = state.stageSize.h;
  }

  function createFieldEl(key, cfg) {
    const el = document.createElement('div'); el.className = 'field'; el.dataset.key = key;
    const label = document.createElement('div'); label.className = 'label'; label.textContent = key;
    el.appendChild(label);
    if (cfg.type === 'image') { el.innerHTML += `<img src="${cfg.src}">`; } 
    else { el.innerHTML += '<div class="text"></div>'; }
    fieldsContainer.appendChild(el);
    state.fields[key] = { ...cfg };
    if (!state.order.includes(key)) state.order.push(key);
    updateFieldElement(key);
    interact(el)
      .draggable({ listeners: { start: clearGuides, move: dragMoveListener, end: (e) => { clearGuides(); syncFromElement(e); } } })
      .resizable({ edges: { left: true, right: true, bottom: true, top: true }, listeners: { move: resizeMoveListener, end: syncFromElement } });
    el.addEventListener('mousedown', (e) => { e.stopPropagation(); selectField(key); });
    return el;
  }
  
  const snapThreshold = 6;
  let guides = [];
  function clearGuides() { guides.forEach(g => g.remove()); guides = []; }
  function drawGuide(x1, y1, x2, y2) { const guide = document.createElement('div'); guide.className = 'guide ' + (x1 === x2 ? 'guide-v' : 'guide-h'); Object.assign(guide.style, { left: `${x1}px`, top: `${y1}px`, width: `${x2-x1}px`, height: `${y2-y1}px` }); fieldsContainer.appendChild(guide); guides.push(guide); }

  function dragMoveListener(event) {
    clearGuides();
    const target = event.target; const key = target.dataset.key; const f = state.fields[key];
    let newX = f.x + event.dx; let newY = f.y + event.dy;
    const targetBounds = { left: newX, top: newY, right: newX + f.w, bottom: newY + f.h, centerX: newX + f.w / 2, centerY: newY + f.h / 2 };
    Object.keys(state.fields).forEach(otherKey => {
      if (otherKey === key) return;
      const other = state.fields[otherKey];
      const otherBounds = { left: other.x, top: other.y, right: other.x + other.w, bottom: other.y + other.h, centerX: other.x + other.w / 2, centerY: other.y + other.h / 2 };
      const checkSnap = (targetVal, otherVal, axis) => {
        if (Math.abs(targetVal - otherVal) < snapThreshold) {
          if (axis === 'x') {
            newX += otherVal - targetVal;
            drawGuide(otherVal, Math.min(targetBounds.top, otherBounds.top) - 10, otherVal, Math.max(targetBounds.bottom, otherBounds.bottom) + 10);
          } else {
            newY += otherVal - targetVal;
            drawGuide(Math.min(targetBounds.left, otherBounds.left) - 10, otherVal, Math.max(targetBounds.right, otherBounds.right) + 10, otherVal);
          }
          return true;
        }
        return false;
      };
      ['left', 'right', 'centerX'].some(p1 => ['left', 'right', 'centerX'].some(p2 => checkSnap(targetBounds[p1], otherBounds[p2], 'x')));
      ['top', 'bottom', 'centerY'].some(p1 => ['top', 'bottom', 'centerY'].some(p2 => checkSnap(targetBounds[p1], otherBounds[p2], 'y')));
    });
    f.x = newX; f.y = newY;
    updateFieldElement(key);
  }

  function resizeMoveListener(event) {
    const target = event.target; const key = target.dataset.key; const f = state.fields[key];
    let newWidth = event.rect.width; let newHeight = event.rect.height;
    if (f.ratioLocked && f.aspectRatio) {
        if (newWidth !== f.w) { newHeight = newWidth / f.aspectRatio; } 
        else if (newHeight !== f.h) { newWidth = newHeight * f.aspectRatio; }
    }
    f.w = newWidth; f.h = newHeight;
    f.x += event.deltaRect.left; f.y += event.deltaRect.top;
    updateFieldElement(key);
  }

  function syncFromElement(event) {
    const key = event.target.dataset.key;
    if (state.selected === key) loadProps(key);
  }
  
  function updateFieldElement(key) {
    const f = state.fields[key];
    const el = [...fieldsContainer.querySelectorAll('.field')].find(e => e.dataset.key === key);
    if (!el) return;
    el.style.left = f.x + 'px'; el.style.top = f.y + 'px';
    el.style.width = f.w + 'px'; el.style.height = f.h + 'px';
    if (f.type === 'text') {
        const textEl = el.querySelector('.text');
        textEl.textContent = f.sample || '';
        Object.assign(textEl.style, { fontFamily: `"${f.font}", sans-serif`, fontSize: `${f.size}px`, color: f.color, textAlign: f.align });
    }
  }

  function selectField(key) { state.selected = key; document.querySelectorAll('.field').forEach(f => f.classList.toggle('active', f.dataset.key === key)); loadProps(key); }
  function deselectAll() { state.selected = null; document.querySelectorAll('.field').forEach(f => f.classList.remove('active')); loadProps(null); }

  function loadProps(key) {
    const f = state.fields[key];
    if (!f) { noSel.style.display = 'block'; props.style.display = 'none'; return; }
    noSel.style.display = 'none'; props.style.display = 'block';
    textProps.style.display = f.type === 'text' ? 'block' : 'none';
    imageProps.style.display = f.type === 'image' ? 'flex' : 'none';
    pKey.value = key;
    if (f.type === 'text') {
        pSample.value = f.sample || '';
        Object.assign(pFont, {value: f.size}); Object.assign(pColor, {value: f.color}); Object.assign(pFamily, {value: f.font}); Object.assign(pAlign, {value: f.align});
    } else if (f.type === 'image') { pLockRatio.checked = f.ratioLocked || false; }
    pX.value = Math.round(f.x); pY.value = Math.round(f.y); pW.value = Math.round(f.w); pH.value = Math.round(f.h);
  }

  function applyProps() {
    const key = state.selected; if (!key) return;
    const f = state.fields[key];
    if (f.type === 'text') { Object.assign(f, { sample: pSample.value, size: Number(pFont.value), color: pColor.value, font: pFamily.value, align: pAlign.value }); }
    else if (f.type === 'image') { f.ratioLocked = pLockRatio.checked; if (f.ratioLocked && !f.aspectRatio) { f.aspectRatio = f.w / f.h; } }
    Object.assign(f, { x: Number(pX.value), y: Number(pY.value), w: Number(pW.value), h: Number(pH.value) });
    if (f.ratioLocked && f.aspectRatio && f.type === 'image') { f.h = f.w / f.aspectRatio; pH.value = Math.round(f.h); }
    updateFieldElement(key);
  }

  function mountDefaults() { fieldsContainer.innerHTML = ''; state.fields = {}; state.order = []; Object.entries(defaultFields).forEach(([k, cfg]) => createFieldEl(k, cfg)); deselectAll(); }
  
  // === LÓGICA DE GERAÇÃO ===
  async function preloadImages() {
      const imagePromises = [];
      const imageCache = {};
      if (state.bg) { imageCache['__background'] = state.bg; }
      for (const key in state.fields) {
          if (state.fields[key].type === 'image') {
              const promise = new Promise((resolve, reject) => {
                  const img = new Image();
                  img.crossOrigin = "Anonymous";
                  img.onload = () => { imageCache[key] = img; resolve(); };
                  img.onerror = reject;
                  img.src = state.fields[key].src;
              });
              imagePromises.push(promise);
          }
      }
      await Promise.all(imagePromises);
      return imageCache;
  }

  function drawTextField(ctx, text, f) {
    ctx.save();
    ctx.font = `${f.size || 24}px "${f.font || 'Poppins'}"`;
    ctx.fillStyle = f.color || '#000';
    ctx.textAlign = f.align || 'center';
    ctx.textBaseline = 'middle';
    let tx = f.x;
    if (f.align === 'center') tx += f.w / 2;
    if (f.align === 'right') tx += f.w;
    
    // Simples quebra de linha por palavra
    const words = String(text).split(' ');
    let lines = [];
    let currentLine = words[0] || '';
    for (let i = 1; i < words.length; i++) {
        const word = words[i];
        if (f.w > 0 && ctx.measureText(currentLine + " " + word).width < f.w) {
            currentLine += " " + word;
        } else {
            lines.push(currentLine);
            currentLine = word;
        }
    }
    lines.push(currentLine);

    const lineHeight = (f.size || 24) * 1.2;
    let startY = (f.y + f.h / 2) - (lines.length - 1) * lineHeight / 2;
    
    lines.forEach(line => {
        ctx.fillText(line, tx, startY);
        startY += lineHeight;
    });
    ctx.restore();
  }
  
  /**
   * NOVA LÓGICA DE RENDERIZAÇÃO
   * Esta função agora substitui dinamicamente o texto de um campo
   * se o ID do campo corresponder a um nome de coluna no Excel.
   */
  async function renderCanvas(imageCache, rowData = null) {
      const canvas = document.createElement('canvas');
      canvas.width = state.stageSize.w; canvas.height = state.stageSize.h;
      const ctx = canvas.getContext('2d');
      
      // Desenha o fundo
      if (imageCache['__background']) {
          ctx.drawImage(imageCache['__background'], 0, 0, canvas.width, canvas.height);
      } else {
          ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--default-bg');
          ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
      
      // Desenha cada campo (imagem ou texto)
      for (const key of state.order) { // 'key' é o ID do campo, ex: 'nome', 'curso'
          const f = state.fields[key];
          
          if (f.type === 'image') {
              if (imageCache[key]) ctx.drawImage(imageCache[key], f.x, f.y, f.w, f.h);
          } else { // Se for um campo de texto
              let value = f.sample || ''; // O valor padrão é o texto de exemplo
              
              // Se estivermos gerando em lote (rowData existe)...
              if (rowData) {
                  // Verifique se a linha de dados do Excel (rowData) tem uma propriedade
                  // com o mesmo nome que o ID do campo (key).
                  if (rowData.hasOwnProperty(key)) {
                      // Se houver correspondência, use o valor da planilha Excel.
                      value = rowData[key];
                  }
              }
              
              // Desenha o texto no canvas com o valor final (da planilha ou de exemplo)
              drawTextField(ctx, value, f);
          }
      }
      return canvas;
  }
  
  // === Event Listeners ===
  $('#bgInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      setStatus(`Carregando imagem...`);
      const reader = new FileReader();
      reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
              state.bg = img;
              stage.style.backgroundImage = `url(${img.src})`;
              stage.style.backgroundColor = 'transparent';
              initStageSize(img.naturalWidth, img.naturalHeight);
              setStatus(`Modelo: ${file.name}`);
          };
          img.onerror = () => {
              setStatus(`Erro: Arquivo de imagem inválido.`);
              alert("Não foi possível carregar a imagem. Por favor, selecione um arquivo PNG ou JPG válido.");
          };
          img.src = event.target.result;
      };
      reader.onerror = () => {
        setStatus(`Erro ao ler o arquivo.`);
        alert("Ocorreu um erro ao tentar ler o arquivo selecionado.");
      };
      reader.readAsDataURL(file);
  });
  
  $('#btnClearBg').addEventListener('click', () => {
      state.bg = null;
      stage.style.backgroundImage = 'none';
      stage.style.backgroundColor = 'var(--default-bg)';
      initStageSize(1280, 720);
      setStatus('Pronto para iniciar');
  });

  btnAddLogo.addEventListener('click', () => logoInput.click());
  logoInput.addEventListener('change', e => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = () => { const key = `logo_${Object.keys(state.fields).length}`; const img = new Image(); img.onload = () => { createFieldEl(key, { type: 'image', src: reader.result, x: 100, y: 100, w: img.width > 300 ? 300 : img.width, h: img.height > 150 ? 150 : img.height, ratioLocked: true, aspectRatio: img.width/img.height }); selectField(key); }; img.src = reader.result; }; reader.readAsDataURL(file); });
  $('#btnAddText').addEventListener('click', () => { const key = `texto_${Object.keys(state.fields).length}`; createFieldEl(key, { type: 'text', x: 100, y: 100, w: 300, h: 50, font: 'Poppins', size: 24, color: '#000000', align: 'left', sample: 'Novo Texto' }); selectField(key); });
  
  btnDownloadPreview.addEventListener('click', async () => {
    btnDownloadPreview.disabled = true; btnGerar.disabled = true;
    try {
        setStatus('Carregando imagens...');
        const imageCache = await preloadImages();
        setStatus('Gerando prévia...');
        const canvas = await renderCanvas(imageCache, null);
        canvas.toBlob(blob => {
            saveAs(blob, 'previa_certificado.png');
            setStatus('Prévia gerada!');
        });
    } catch(e) {
        setStatus('Erro ao gerar prévia.');
        console.error("Preview Error:", e);
    } finally {
        btnDownloadPreview.disabled = false;
        checkReady();
    }
  });

  btnGerar.addEventListener('click', async () => {
    if (!state.data.length || !state.map.nome) {
      return alert('Carregue uma planilha e selecione a "Coluna NOME" para nomear os arquivos.');
    }
    btnGerar.disabled = true; btnDownloadPreview.disabled = true;
    setStatus('Iniciando...');
    const zip = new JSZip(); const folder = zip.folder('certificados');
    try {
        setStatus('Carregando imagens e fontes...');
        const imageCache = await preloadImages();
        for (let i = 0; i < state.data.length; i++) {
            const row = state.data[i];
            setStatus(`Gerando ${i + 1} de ${state.data.length}...`);
            const canvas = await renderCanvas(imageCache, row);
            const participantName = row[state.map.nome] || `certificado_${i+1}`;
            const safeName = participantName.replace(/[^a-z0-9\s-]/gi, '').trim();
            folder.file(`${safeName}.png`, canvas.toDataURL('image/png').split(',')[1], { base64: true });
        }
        setStatus('Compactando arquivos...');
        const blob = await zip.generateAsync({type: 'blob'});
        saveAs(blob, 'certificados.zip');
        setStatus(`${state.data.length} certificados gerados com sucesso!`);
    } catch(e) {
        setStatus('Ocorreu um erro ao gerar o ZIP.');
        console.error("ZIP Generation Error:", e);
    } finally {
        btnDownloadPreview.disabled = false;
        checkReady();
    }
  });
  
  [pSample, pX, pY, pW, pH, pFont, pColor, pFamily, pAlign, pLockRatio].forEach(el => el.addEventListener('input', applyProps));
  $('#btnSalvarLayout').addEventListener('click', () => { const layout = { stage: state.stageSize, fields: state.fields, order: state.order }; saveAs(new Blob([JSON.stringify(layout, null, 2)], { type: 'application/json' }), 'layout.json'); });
  $('#btnCarregarLayout').addEventListener('click', () => $('#loadLayout').click());
  $('#loadLayout').addEventListener('change', async e => { const file = e.target.files[0]; if (!file) return; const layout = JSON.parse(await file.text()); if (layout.stage) initStageSize(layout.stage.w, layout.stage.h); fieldsContainer.innerHTML = ''; state.fields = {}; state.order = []; Object.entries(layout.fields || {}).forEach(([k, cfg]) => createFieldEl(k, cfg)); state.order = layout.order || Object.keys(state.fields); deselectAll(); });
  stage.addEventListener('mousedown', deselectAll);
  $('#btnCenterH').addEventListener('click', () => { if (!state.selected) return; const f = state.fields[state.selected]; f.x = (state.stageSize.w / 2) - (f.w / 2); updateFieldElement(state.selected); loadProps(state.selected); });
  $('#btnCenterV').addEventListener('click', () => { if (!state.selected) return; const f = state.fields[state.selected]; f.y = (state.stageSize.h / 2) - (f.h / 2); updateFieldElement(state.selected); loadProps(state.selected); });
  $('#btnDuplicar').addEventListener('click', () => { if(!state.selected) return; const f = state.fields[state.selected]; const key = `${state.selected}_copia`; const newCfg = {...f}; newCfg.x += 20; newCfg.y += 20; createFieldEl(key, newCfg); selectField(key); });
  $('#btnRemover').addEventListener('click', () => { if(!state.selected || !confirm(`Remover "${state.selected}"?`)) return; const el = [...fieldsContainer.querySelectorAll('.field')].find(e => e.dataset.key === state.selected); el.remove(); delete state.fields[state.selected]; state.order = state.order.filter(k => k !== state.selected); deselectAll(); });
  fileInput.addEventListener('change', async e => { const file = e.target.files[0]; if (!file) return; const wb = XLSX.read(await file.arrayBuffer(), { type: 'array' }); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '' }); state.data = json; state.headers = Object.keys(json[0] || {}); fillSelect(colNome, state.headers, true); fillSelect(colCPF, state.headers, true); autoMap(); setStatus(`Lista com ${state.data.length} linhas carregada.`); checkReady(); });
  function fillSelect(sel, arr, addEmpty = false) { sel.innerHTML = ''; if (addEmpty) sel.add(new Option('Selecione...', '')); arr.forEach(h => sel.add(new Option(h, h))); }
  function autoMap() { const find = (k) => state.headers.find(h => h.toLowerCase().includes(k)) || null; colNome.value = find('nome') || state.headers[0] || ''; colCPF.value = find('cpf') || ''; state.map.nome = colNome.value; state.map.cpf = colCPF.value; }
  colNome.addEventListener('change', () => { state.map.nome = colNome.value; checkReady(); });
  colCPF.addEventListener('change', () => { state.map.cpf = colCPF.value; checkReady(); });
  function checkReady() { const ready = state.data.length > 0 && state.map.nome; btnGerar.disabled = !ready; if (ready) setStatus(`${state.data.length} certificados prontos para gerar.`); }
  
  function boot() {
    initStageSize(1280, 720);
    mountDefaults();
    setStatus('Pronto para iniciar');
  }
  boot();
</script>
</body>
</html>
