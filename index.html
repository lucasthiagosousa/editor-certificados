<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Editor Visual de Certificados</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">
  <style>
    /* 
    ==================================================
    ==  CONFIGURA√á√ïES GLOBAIS DE ESTILO (ALTERE AQUI) ==
    ==================================================
    */
    :root {
      /* Cores principais do tema */
      --bg: #0f172a; 
      --panel: #0b1220; 
      --muted: #94a3b8; 
      --accent: #22d3ee; 
      --accent2: #a78bfa;
      --border: rgba(255, 255, 255, 0.12); 
      --shadow: 0 6px 24px rgba(0, 0, 0, 0.32);

      /* Cor principal dos textos */
      --text-color: #e5e7eb;
    }

    body {
      margin: 0;
      /* Altere a fonte principal do site aqui */
      font-family: 'Poppins', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #0f172a, #111827 35%, #0b1220);
      color: var(--text-color);
      font-size: 14px; /* Tamanho base da fonte */
    }
    /* ================================================ */
    
    * { box-sizing: border-box; }

    .wrap {
      max-width: 1400px;
      margin: 24px auto; /* Centraliza o conte√∫do na tela */
      padding: 0 24px;
    }

    header {
      display: flex;
      flex-wrap: wrap; /* Permite quebrar linha em telas menores */
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    header h1 {
      font-family: "Playfair Display", serif;
      font-weight: 700;
      letter-spacing: .2px;
      font-size: clamp(26px, 3.5vw, 36px);
      margin: 0;
    }
    header .sub { color: var(--muted); }

    .grid {
      display: grid;
      grid-template-columns: 360px 1fr 340px;
      gap: 24px;
    }

    /* === RESPONSIVIDADE === */
    @media (max-width: 1200px) {
      .grid {
        grid-template-columns: 1fr; /* Coluna √∫nica em telas menores */
      }
      .right { order: 3; }
      .editor { order: 2; }
      .left { order: 1; }
    }

    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 20px;
      box-shadow: var(--shadow);
    }
    .card h2 {
      margin: 4px 0 16px;
      font-size: 18px;
      font-weight: 700;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }
    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin: 12px 0 6px;
      color: #cbd5e1;
    }
    input, select, button, textarea {
      width: 100%;
      background: #0b1220;
      border: 1px solid var(--border);
      color: var(--text-color);
      border-radius: 12px;
      padding: 10px 14px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s ease;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }
    .btn {
      cursor: pointer;
      font-weight: 700;
      border: 0;
      padding: 11px 16px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #051018;
    }
    .btn-ghost {
      cursor: pointer;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #0b1220;
      transition: background-color 0.2s, border-color 0.2s;
    }
    .btn-ghost:hover {
      background-color: rgba(255,255,255,0.05);
      border-color: var(--muted);
    }
    .muted { color: var(--muted); font-size: 13px; margin: 8px 0 0; }

    /* === Editor === (CORRE√á√ÉO APLICADA AQUI) */
    .editor { display: grid; grid-template-rows: auto 1fr; }
    .stage-wrap {
      background: #0b1220;
      border: 1px dashed var(--border);
      border-radius: 18px;
      padding: 12px;
      display: grid; /* Mant√©m o grid para centralizar o conte√∫do inicial */
      place-items: center;
      min-height: 420px;
      overflow: auto; /* IMPORTANTE: Permite o scroll da √°rea de edi√ß√£o */
    }
    .stage {
      position: relative;
      /* max-width e max-height removidos para permitir expans√£o total */
      overflow: visible; /* O scroll √© controlado pelo pai (.stage-wrap) */
      background: #000;
      border-radius: 12px; /* Adicionado para consist√™ncia */
    }
    .bg { display: block; max-width: none; height: auto; } /* max-width: none √© crucial */

    .field {
      position: absolute;
      min-width: 140px;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px 8px;
      border: 1px dashed rgba(255, 255, 255, 0.45);
      border-radius: 10px;
      background: rgba(34, 211, 238, 0.08);
      backdrop-filter: blur(2px);
      cursor: move;
      transition: outline 0.1s ease;
    }
    .field.active { outline: 2px solid var(--accent); }
    .field .label {
      position: absolute;
      top: -20px;
      left: 0;
      font-size: 12px;
      font-weight: 600;
      background: rgba(0, 0, 0, 0.6);
      padding: 3px 8px;
      border-radius: 999px;
    }
    .field .text { width: 100%; text-align: center; pointer-events: none; }

    .right .kv { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 13px;
    }
    .footer { margin-top: 16px; color: #94a3b8; font-size: 13px; }
    .badge {
      font-size: 13px;
      background: rgba(34, 211, 238, 0.12);
      color: #a5f3fc;
      border: 1px solid rgba(34, 211, 238, 0.35);
      padding: 6px 12px;
      border-radius: 999px;
      text-align: center;
    }
  </style>
  <!-- Bibliotecas JS (CORRE√á√ÉO: FileSaver.js foi adicionado) -->
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Editor Visual de Certificados</h1>
        <div class="sub">Suba seu <b>modelo de fundo</b>, posicione os campos (drag & resize) e gere em lote via Excel/CSV.</div>
      </div>
      <div class="pill">Tudo roda localmente no seu navegador üîí</div>
    </header>

    <div class="grid">
      <!-- LADO ESQUERDO: Uploads e dados -->
      <section class="card left">
        <h2>1. Modelo de Fundo</h2>
        <label>Imagem (PNG/JPG) ‚Äî define o tamanho</label>
        <input id="bgInput" type="file" accept="image/*">
        <div class="row">
          <div>
            <label for="w">Largura (px)</label>
            <input id="w" type="number" placeholder="ex.: 2480" />
          </div>
          <div>
            <label for="h">Altura (px)</label>
            <input id="h" type="number" placeholder="ex.: 1754" />
          </div>
        </div>
        <div class="actions">
          <button id="btnApplySize" class="btn-ghost">Aplicar tamanho</button>
          <button id="btnClearBg" class="btn-ghost">Limpar fundo</button>
        </div>
        <div class="muted">Dica: 2480√ó1754 ‚âà A4 horizontal @300 DPI.</div>

        <h2 style="margin-top:20px">2. Dados Fixos</h2>
        <label for="empresa">Empresa</label>
        <input id="empresa" placeholder="Ex.: Elev Tecnologia" />
        <label for="curso">Curso</label>
        <input id="curso" placeholder="Ex.: Fundamentos de Redes" />
        <div class="row">
          <div>
            <label for="carga">Carga hor√°ria</label>
            <input id="carga" placeholder="Ex.: 8 horas" />
          </div>
          <div>
            <label for="dataCert">Data</label>
            <input id="dataCert" type="date" />
          </div>
        </div>
        <label for="responsavel">Respons√°vel / Assinatura</label>
        <input id="responsavel" placeholder="Ex.: Jo√£o Silva ‚Äì Gestor" />

        <h2 style="margin-top:20px">3. Lista (Excel/CSV)</h2>
        <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
        <div class="row">
          <div>
            <label>Coluna NOME</label>
            <select id="colNome"></select>
          </div>
          <div>
            <label>Coluna CPF</label>
            <select id="colCPF"></select>
          </div>
        </div>
        <div class="actions">
          <button id="btnPreviewDemo" class="btn-ghost">Usar dados de exemplo</button>
          <button id="btnGerar" class="btn" disabled>Gerar ZIP (PNGs)</button>
        </div>
      </section>

      <!-- CENTRO: Editor visual -->
      <section class="card editor">
        <h2>Editor (arraste e redimensione os campos)</h2>
        <div class="stage-wrap">
          <div id="stage" class="stage">
            <img id="bg" class="bg" alt="Modelo do Certificado" />
            <!-- Campos edit√°veis s√£o inseridos aqui via JS -->
          </div>
        </div>
        <div class="actions" style="margin-top:10px">
          <button id="btnAddCampo" class="btn-ghost">+ Campo</button>
          <button id="btnResetCampos" class="btn-ghost">Resetar Campos</button>
          <button id="btnSalvarLayout" class="btn">Salvar Layout</button>
          <input id="loadLayout" type="file" accept="application/json" style="display:none" />
          <button id="btnCarregarLayout" class="btn-ghost">Carregar Layout</button>
        </div>
      </section>

      <!-- DIREITA: Propriedades do campo selecionado -->
      <section class="card right">
        <h2>Propriedades do Campo</h2>
        <div id="noSel" class="muted">Nenhum campo selecionado. Clique em um campo no editor para customiz√°-lo.</div>
        <div id="props" style="display:none">
          <label>ID do Campo</label>
          <input id="pKey" readonly>
          <label>Texto de exemplo (pr√©via)</label>
          <input id="pSample" placeholder="Ex.: Maria da Silva" />
          <div class="kv">
            <div><label>X (px)</label><input id="pX" type="number" /></div>
            <div><label>Y (px)</label><input id="pY" type="number" /></div>
          </div>
          <div class="kv">
            <div><label>Largura (px)</label><input id="pW" type="number" /></div>
            <div><label>Altura (px)</label><input id="pH" type="number" /></div>
          </div>
          <div class="kv">
            <div><label>Tamanho (px)</label><input id="pFont" type="number" /></div>
            <div><label>Cor</label><input id="pColor" type="color" value="#ffffff" /></div>
          </div>
          <label>Fonte</label>
          <select id="pFamily">
            <option value="Playfair Display">Playfair Display</option>
            <option value="Poppins">Poppins</option>
            <option value="serif">Serif (Padr√£o)</option>
            <option value="sans-serif">Sans-Serif (Padr√£o)</option>
            <option value="monospace">Monospace (Padr√£o)</option>
          </select>
          <label>Alinhamento</label>
          <select id="pAlign">
            <option value="center">Centro</option>
            <option value="left">Esquerda</option>
            <option value="right">Direita</option>
          </select>
          <div class="actions">
            <button id="btnDuplicar" class="btn-ghost">Duplicar</button>
            <button id="btnRemover" class="btn-ghost">Remover</button>
          </div>
        </div>

        <h2 style="margin-top:20px">Status</h2>
        <div class="badge" id="status">Aguardando modelo e lista...</div>
        <div class="footer">Dica: salve seu layout em JSON para reutilizar em outros eventos.</div>
      </section>
    </div>
  </div>

<script>
  // ======== Estado da Aplica√ß√£o ========
  const state = {
    bg: null, // Objeto Image() do fundo
    stageSize: { w: 1200, h: 850 },
    fields: {}, // key -> {x,y,w,h,font,size,color,align,sample}
    order: [], // Ordem de sobreposi√ß√£o (z-index l√≥gico)
    data: [], // Dados da planilha
    headers: [], // Cabe√ßalhos da planilha
    map: { nome: null, cpf: null },
    selected: null // ID do campo selecionado
  };

  // ======== Seletores de Elementos do DOM ========
  const $ = (selector) => document.querySelector(selector);
  const stage = $('#stage'), bgEl = $('#bg'), wEl = $('#w'), hEl = $('#h'), statusEl = $('#status');
  const empresa = $('#empresa'), curso = $('#curso'), carga = $('#carga'), dataCert = $('#dataCert'), responsavel = $('#responsavel');
  const fileInput = $('#fileInput'), colNome = $('#colNome'), colCPF = $('#colCPF');
  const btnGerar = $('#btnGerar');
  const noSel = $('#noSel'), props = $('#props'), pKey = $('#pKey'), pSample = $('#pSample'), pX = $('#pX'), pY = $('#pY'), pW = $('#pW'), pH = $('#pH'), pFont = $('#pFont'), pColor = $('#pColor'), pFamily = $('#pFamily'), pAlign = $('#pAlign');

  // ======== Campos Padr√£o ========
  const defaultFields = {
    nome: { x: 150, y: 300, w: 900, h: 70, font:'Playfair Display', size:64, color:'#ffffff', align:'center', sample:'Nome do Participante' },
    cpf:  { x: 150, y: 380, w: 900, h: 40, font:'Poppins', size:28, color:'#cbd5e1', align:'center', sample:'123.456.789-00' },
    empresa: { x: 100, y: 120, w: 600, h: 36, font:'Poppins', size:24, color:'#e5e7eb', align:'left', sample:'Nome da Empresa' },
    curso: { x: 100, y: 200, w: 900, h: 44, font:'Poppins', size:32, color:'#e5e7eb', align:'left', sample:'Nome do Curso' },
    carga: { x: 100, y: 440, w: 420, h: 36, font:'Poppins', size:24, color:'#d1d5db', align:'left', sample:'Carga Hor√°ria' },
    data:  { x: 540, y: 440, w: 420, h: 36, font:'Poppins', size:24, color:'#d1d5db', align:'right', sample:'Data de Emiss√£o' },
    responsavel: { x: 150, y: 540, w: 900, h: 30, font:'Poppins', size:22, color:'#cbd5e1', align:'center', sample:'Respons√°vel e Assinatura' },
  };

  // ======== Fun√ß√µes Utilit√°rias ========
  const uuid = () => 'id' + Math.random().toString(36).slice(2, 9);
  const setStatus = (t) => { statusEl.textContent = t; };

  function initStageSize(w, h) {
    state.stageSize = { w: Number(w) || 1200, h: Number(h) || 850 };
    stage.style.width = state.stageSize.w + 'px';
    stage.style.height = state.stageSize.h + 'px';
    wEl.value = state.stageSize.w;
    hEl.value = state.stageSize.h;
    if (state.bg) {
      bgEl.width = state.stageSize.w;
      bgEl.height = state.stageSize.h;
    }
  }

  // ======== L√≥gica do Editor Visual ========
  function createFieldEl(key, cfg) {
    const el = document.createElement('div');
    el.className = 'field';
    el.dataset.key = key;
    
    const label = document.createElement('div');
    label.className = 'label';
    label.textContent = key;

    const text = document.createElement('div');
    text.className = 'text';

    el.append(label, text);
    stage.appendChild(el);
    
    state.fields[key] = { ...cfg };
    if (!state.order.includes(key)) state.order.push(key);
    
    updateFieldElement(key); // Aplica estilos e posi√ß√£o

    interact(el)
      .draggable({ listeners: { move: dragMoveListener, end: syncFromElement } })
      .resizable({ edges: { left: true, right: true, bottom: true, top: true }, listeners: { move: resizeMoveListener, end: syncFromElement } });
    
    el.addEventListener('click', (e) => { e.stopPropagation(); selectField(key); });

    return el;
  }

  function dragMoveListener(event) {
    const target = event.target;
    const x = (parseFloat(target.dataset.x) || 0) + event.dx;
    const y = (parseFloat(target.dataset.y) || 0) + event.dy;
    target.style.transform = `translate(${x}px, ${y}px)`;
    target.dataset.x = x; target.dataset.y = y;
  }

  function resizeMoveListener(event) {
    const target = event.target;
    let x = parseFloat(target.dataset.x) || 0;
    let y = parseFloat(target.dataset.y) || 0;
    target.style.width = event.rect.width + 'px';
    target.style.height = event.rect.height + 'px';
    x += event.deltaRect.left;
    y += event.deltaRect.top;
    target.style.transform = `translate(${x}px, ${y}px)`;
    target.dataset.x = x;
    target.dataset.y = y;
  }

  function syncFromElement(event) {
    const el = event.target;
    const key = el.dataset.key;
    const f = state.fields[key];
    
    f.x += (parseFloat(el.dataset.x) || 0);
    f.y += (parseFloat(el.dataset.y) || 0);
    f.w = parseFloat(el.style.width) || f.w;
    f.h = parseFloat(el.style.height) || f.h;

    el.style.transform = 'translate(0, 0)';
    el.dataset.x = 0;
    el.dataset.y = 0;
    
    updateFieldElement(key);
    if (state.selected === key) loadProps(key);
  }
  
  function updateFieldElement(key) {
    const f = state.fields[key];
    const el = [...stage.querySelectorAll('.field')].find(e => e.dataset.key === key);
    if (!el) return;

    el.style.left = f.x + 'px';
    el.style.top = f.y + 'px';
    el.style.width = f.w + 'px';
    el.style.height = f.h + 'px';

    const textEl = el.querySelector('.text');
    textEl.textContent = f.sample || '';
    textEl.style.fontFamily = f.font;
    textEl.style.fontSize = f.size + 'px';
    textEl.style.color = f.color;
    textEl.style.textAlign = f.align;
  }

  function selectField(key) {
    state.selected = key;
    document.querySelectorAll('.field').forEach(f => f.classList.toggle('active', f.dataset.key === key));
    loadProps(key);
  }

  function loadProps(key) {
    const f = state.fields[key];
    if (!f) {
        noSel.style.display = 'block';
        props.style.display = 'none';
        return;
    }
    noSel.style.display = 'none';
    props.style.display = 'block';
    pKey.value = key;
    pSample.value = f.sample || '';
    pX.value = Math.round(f.x); pY.value = Math.round(f.y);
    pW.value = Math.round(f.w); pH.value = Math.round(f.h);
    pFont.value = f.size; pColor.value = f.color; pFamily.value = f.font; pAlign.value = f.align;
  }

  function applyProps() {
    const key = state.selected; if (!key) return;
    const f = state.fields[key];
    Object.assign(f, {
      sample: pSample.value, x: Number(pX.value), y: Number(pY.value),
      w: Number(pW.value), h: Number(pH.value), size: Number(pFont.value),
      color: pColor.value, font: pFamily.value, align: pAlign.value
    });
    updateFieldElement(key);
  }

  [pSample, pX, pY, pW, pH, pFont, pColor, pFamily, pAlign].forEach(el => {
    el.addEventListener('input', applyProps);
  });

  function mountDefaults() {
    stage.querySelectorAll('.field').forEach(n => n.remove());
    state.fields = {}; state.order = [];
    Object.entries(defaultFields).forEach(([k, cfg]) => createFieldEl(k, cfg));
    selectField('nome');
  }

  // ======== Manipula√ß√£o de Arquivos (Fundo, Layout, Excel) ========
  $('#bgInput').addEventListener('change', e => {
    const file = e.target.files[0]; if (!file) return;
    const img = new Image();
    img.onload = () => {
      state.bg = img;
      bgEl.src = URL.createObjectURL(file);
      initStageSize(img.naturalWidth, img.naturalHeight);
      setStatus(`Modelo: ${file.name}`);
    };
    img.src = URL.createObjectURL(file);
  });
  
  $('#btnApplySize').addEventListener('click', () => initStageSize(wEl.value, hEl.value));
  $('#btnClearBg').addEventListener('click', () => {
    state.bg = null; bgEl.removeAttribute('src'); setStatus('Sem modelo de fundo');
  });

  $('#btnSalvarLayout').addEventListener('click', () => {
    const layout = { stage: state.stageSize, fields: state.fields, order: state.order };
    saveAs(new Blob([JSON.stringify(layout, null, 2)], { type: 'application/json' }), 'layout_certificado.json');
  });
  
  $('#btnCarregarLayout').addEventListener('click', () => $('#loadLayout').click());
  $('#loadLayout').addEventListener('change', async (e) => {
    const file = e.target.files[0]; if (!file) return;
    const layout = JSON.parse(await file.text());
    if (layout.stage) initStageSize(layout.stage.w, layout.stage.h);
    stage.querySelectorAll('.field').forEach(n => n.remove());
    state.fields = {}; state.order = [];
    Object.entries(layout.fields || {}).forEach(([k, cfg]) => createFieldEl(k, cfg));
    state.order = layout.order || Object.keys(state.fields);
    if(state.order[0]) selectField(state.order[0]);
  });

  $('#btnAddCampo').addEventListener('click', () => {
    const key = prompt('Nome do novo campo (sem espa√ßos, use _):', `campo_${Object.keys(state.fields).length}`);
    if (!key || state.fields[key]) return;
    createFieldEl(key, { x: 100, y: 100, w: 300, h: 40, font: 'Poppins', size: 22, color: '#ffffff', align: 'left', sample: 'Novo Campo' });
    selectField(key);
  });

  $('#btnResetCampos').addEventListener('click', () => mountDefaults());
  
  $('#btnDuplicar').addEventListener('click', () => {
      if(!state.selected) return;
      const key = `${state.selected}_copia`;
      if(state.fields[key]) return;
      const newCfg = {...state.fields[state.selected]};
      newCfg.x += 20; newCfg.y += 20;
      createFieldEl(key, newCfg);
      selectField(key);
  });

  $('#btnRemover').addEventListener('click', () => {
      if(!state.selected) return;
      if(confirm(`Tem certeza que deseja remover o campo "${state.selected}"?`)){
          const el = [...stage.querySelectorAll('.field')].find(e => e.dataset.key === state.selected);
          el.remove();
          delete state.fields[state.selected];
          state.order = state.order.filter(k => k !== state.selected);
          state.selected = null;
          loadProps(null);
      }
  });

  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0]; if (!file) return;
    const wb = XLSX.read(await file.arrayBuffer(), { type: 'array', raw: true });
    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '', raw: true });
    state.data = json; state.headers = Object.keys(json[0] || {});
    fillSelect(colNome, state.headers, true);
    fillSelect(colCPF, state.headers, true);
    autoMap();
    setStatus(`Lista: ${file.name} (${state.data.length} linhas)`);
    checkReady();
  });

  function fillSelect(sel, arr, addEmpty = false) {
    sel.innerHTML = '';
    if (addEmpty) sel.add(new Option('Selecione...', ''));
    arr.forEach(h => sel.add(new Option(h, h)));
  }

  function autoMap() {
    const find = (k) => state.headers.find(h => h.toLowerCase().includes(k)) || null;
    colNome.value = find('nome') || state.headers[0] || '';
    colCPF.value = find('cpf') || state.headers[1] || '';
    state.map.nome = colNome.value; state.map.cpf = colCPF.value;
  }
  
  colNome.addEventListener('change', () => { 
      state.map.nome = colNome.value;
      // Tenta mapear o CPF automaticamente se n√£o estiver selecionado
      if (!colCPF.value && state.map.nome) {
          const cpfGuess = state.headers.find(h => h.toLowerCase().includes('cpf') && h !== colNome.value);
          if (cpfGuess) {
              colCPF.value = cpfGuess;
              state.map.cpf = colCPF.value;
          }
      }
      checkReady(); 
  });
  colCPF.addEventListener('change', () => { state.map.cpf = colCPF.value; checkReady(); });

  $('#btnPreviewDemo').addEventListener('click', () => {
    state.data = [{ Nome: 'Ana Paula Rocha', CPF: '111.222.333-44' }];
    state.headers = ['Nome', 'CPF'];
    fillSelect(colNome, state.headers); fillSelect(colCPF, state.headers);
    autoMap();
    setStatus('Pr√©via de exemplo pronta para gerar.');
    checkReady();
  });

  function checkReady() {
    const ready = state.data.length > 0 && state.map.nome && Object.keys(state.fields).length > 0;
    btnGerar.disabled = !ready;
    if(ready) setStatus(`${state.data.length} certificado(s) pronto(s) para gerar.`);
  }

  // ======== Gera√ß√£o Final ========
  function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
      const words = String(text).split(' ');
      const lines = [];
      let currentLine = words[0];
      for (let i = 1; i < words.length; i++) {
          const word = words[i];
          const width = ctx.measureText(currentLine + " " + word).width;
          if (width < maxWidth) {
              currentLine += " " + word;
          } else {
              lines.push(currentLine);
              currentLine = word;
          }
      }
      lines.push(currentLine);
      const totalHeight = lines.length * lineHeight;
      let startY = y - totalHeight / 2 + lineHeight / 2;
      lines.forEach(line => {
          ctx.fillText(line, x, startY);
          startY += lineHeight;
      });
  }

  function drawField(ctx, text, f) {
    ctx.save();
    ctx.font = `${f.size || 24}px "${f.font || 'Poppins'}"`;
    ctx.fillStyle = f.color || '#fff';
    ctx.textAlign = f.align || 'center';
    ctx.textBaseline = 'middle';
    
    let tx = f.x;
    if (f.align === 'center') tx += f.w / 2;
    if (f.align === 'right') tx += f.w - 2;

    wrapText(ctx, text, tx, f.y + f.h / 2, f.w, (f.size || 24) * 1.2);
    ctx.restore();
  }
  
  btnGerar.addEventListener('click', async () => {
    if (!state.data.length) return alert('Carregue o Excel/CSV primeiro.');
    btnGerar.disabled = true;
    const zip = new JSZip();
    const pasta = zip.folder('certificados');

    const baseCanvas = document.createElement('canvas');
    baseCanvas.width = state.stageSize.w;
    baseCanvas.height = state.stageSize.h;
    const bctx = baseCanvas.getContext('2d');
    if (state.bg) bctx.drawImage(state.bg, 0, 0, baseCanvas.width, baseCanvas.height);
    else { bctx.fillStyle = '#0b1220'; bctx.fillRect(0, 0, baseCanvas.width, baseCanvas.height); }

    const fixedData = {
        empresa: empresa.value, curso: curso.value, carga: carga.value,
        data: dataCert.value ? new Date(dataCert.value).toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : '',
        responsavel: responsavel.value
    };

    for (let i = 0; i < state.data.length; i++) {
        const row = state.data[i];
        setStatus(`Gerando ${i + 1} de ${state.data.length}...`);
        
        const canvas = document.createElement('canvas');
        canvas.width = baseCanvas.width;
        canvas.height = baseCanvas.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(baseCanvas, 0, 0);

        for (const key of state.order) {
            const f = state.fields[key];
            let value = f.sample || '';
            if (key === 'nome') value = row[state.map.nome] || '';
            else if (key === 'cpf' && state.map.cpf) value = row[state.map.cpf] || '';
            else if (fixedData[key] !== undefined) value = fixedData[key];
            drawField(ctx, value, f);
        }

        const dataUrl = canvas.toDataURL('image/png');
        const safeName = (row[state.map.nome] || `participante_${i+1}`).replace(/[^a-z0-9\s-]/gi, '').trim();
        pasta.file(`${safeName}.png`, dataUrl.split(',')[1], { base64: true });
    }

    const blob = await zip.generateAsync({ type: 'blob' });
    saveAs(blob, 'certificados.zip');
    setStatus(`${state.data.length} certificados gerados com sucesso!`);
    btnGerar.disabled = false;
  });

  // ======== Inicializa√ß√£o ========
  function boot() {
    initStageSize(1200, 850);
    mountDefaults();
    const today = new Date().toISOString().substring(0, 10);
    dataCert.value = today;
    setStatus('Pronto para iniciar');
  }
  boot();
</script>

</body>
</html>
